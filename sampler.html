<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KeyBeat</title>
<style>
body {
    margin: 0;
    padding: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: #ffffff;
    transition: background 0.3s ease;
    font-family: "Helvetica Neue", Arial, sans-serif;
}
#typingBox {
    width: 80%;
    max-width: 900px;
    min-height: 300px;
    outline: none;
    border: none;
    background: transparent;
    font-size: 2rem;
    line-height: 2.6rem;
    color: #222;
    resize: none;
    overflow: hidden;
}
#djPanel {
    width: 80%;
    max-width: 900px;
    padding: 15px;
    border-radius: 12px;
    background: rgba(0,0,0,0.05);
    margin-top: 15px;
    display: flex;
    justify-content: space-between;
}
button {
    padding: 8px 15px;
    font-size: 1rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    background: #222;
    color: white;
}
</style>
</head>
<body>
<!--typing box for the user to make sounds-->
<textarea id="typingBox" autofocus placeholder="Start typing to make music..."></textarea>

<script>
const box = document.getElementById("typingBox");
//allowed letters for the soundboard (only a-z no special characterss)
const letters = "abcdefghijklmnopqrstuvwxyz";
//setting the website up for audio context and convolver for reverb effect
//https://developer.mozilla.org/en-US/docs/Web/API/AudioContext
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const convolver = audioCtx.createConvolver();
function createImpulse(seconds = 2){
    const rate = audioCtx.sampleRate;
    const length = rate * seconds;
    const impulse = audioCtx.createBuffer(2, length, rate);
    for(let i=0;i<2;i++){
        const channel = impulse.getChannelData(i);
        for(let j=0;j<length;j++){
            channel[j] = (Math.random()*2-1)*(1-j/length);
        }
    }
    return impulse;
}
convolver.buffer = createImpulse();
//loading all thr sounds I made into memory for quick access sounds are in the /sounds
const sounds = {};
letters.split('').forEach(letter => {
//fetching the sound files inputs the user inputed letter into the {letter} placeholder
    fetch(`sounds/${letter}.wav`)
        .then(r => r.arrayBuffer())
        .then(buf => audioCtx.decodeAudioData(buf))
        .then(decoded => sounds[letter] = decoded);
});
//the different fx levels,, might add a setting to change this later
let volumeLevel = 0.5;
let reverbLevel = 0;
let delayLevel = 0;
//making it so when using the period it loops the sentence
let currentSentence = "";
let loops = []; // {sentence, intervalId}
//background color changing based on the letter that is pressed
function colorFromLetter(letter){
    const index = letter.charCodeAt(0)-97;
    const hue = (index/26)*360;
    return `hsl(${hue}, 80%, 80%)`;
}

//adding the reverb, volume and delay changes based on the length of the words
//so like if "reverbbbbbb" lots of reveb but "reverb" no reverb and same for volume and delay 
//so just depedgn on the extra letters and length of th word
function extractLevel(word){
    const text = box.value.toLowerCase();
    const idx = text.lastIndexOf(word);
    if(idx===-1) return null;
    const rest = text.slice(idx+word.length).match(/^[a-z]+/);
    if(!rest) return 0;
    return Math.min(rest[0].length*0.1,1);
}
//playngn a single sound based on the letter pressed
function playSound(letter){
    const buffer = sounds[letter];
    if(!buffer) return;
//setting up the audio nodes for volume and reverb
    const source = audioCtx.createBufferSource();
    source.buffer = buffer;
//volume control
    const gainNode = audioCtx.createGain();
    gainNode.gain.value = volumeLevel;
//reverb control
    if(reverbLevel > 0){
        const wetGain = audioCtx.createGain();
        wetGain.gain.value = reverbLevel;
        const dryGain = audioCtx.createGain();
        dryGain.gain.value = 1 - reverbLevel;
//connecting the nodes together
        source.connect(gainNode);
        gainNode.connect(convolver);
        convolver.connect(wetGain);
        wetGain.connect(audioCtx.destination);
        gainNode.connect(dryGain);
        dryGain.connect(audioCtx.destination);
    } else {
        source.connect(gainNode);
        gainNode.connect(audioCtx.destination);
    }
//starting the sound
    source.start();
}
//looping the sentnces when there is a period placed at the end
//will play int eh background until deleted from the box
function loopSentence(sentence){
    let i = 0;
    const interval = setInterval(()=>{
        if(i >= sentence.length) i = 0;
        const key = sentence[i].toLowerCase();
        if(letters.includes(key)) playSound(key);
        i++;
    }, 250);
    loops.push({sentence, intervalId: interval});
}
//keydown event listener to capture user input
document.addEventListener("keydown",(e)=>{
    const key = e.key;
//changing the fx based on the words typed
    const v = extractLevel("volume"); if(v!==null) volumeLevel=v;
    const r = extractLevel("reverb"); if(r!==null) reverbLevel=r;
    const d = extractLevel("delay"); if(d!==null) delayLevel=d;
//building the current sentence for looping
    if(key.length === 1 && key !== "Backspace") currentSentence += key;
//start looping the sentence when period is pressed
    if(key === "."){
        loopSentence(currentSentence);
        currentSentence = "";
    }
//stop looping when backspace is pressed and remove last character from current sentence
    if(key === "Backspace"){
        loops = loops.filter(loop=>{
            if(!box.value.includes(loop.sentence)){
                clearInterval(loop.intervalId);
                return false;
            }
            return true;
        });
        currentSentence = currentSentence.slice(0,-1);
    }
//playing the sound and changing background color when a letter is pressed
    if(letters.includes(key.toLowerCase())){
        playSound(key.toLowerCase());
        document.body.style.background = colorFromLetter(key.toLowerCase());
    }
});
</script>

</body>
</html>
